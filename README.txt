# mikrocat

## Назначение

Небольшой скрипт для автоматического добавления IP в листы Winbox MikroTik через API.

## Основные возможности

- **Автоматическая блокировка по категориям.
- **Блокировка навсегда:** Добавленные IP остаются в списках до ручного удаления.

## Предварительные требования

### 1. Оборудование и ПО
- MikroTik RouterOS (тестировалось на версии 6.x и выше)
- Сервер с Suricata
- Python 3.6+
- Библиотека `librouteros`

### 2. Настройка MikroTik

#### Создание пользователя API:
```
/ip service
set api disabled=no port=8728
/user add name=*** password=*** group=full
```

#### Настройка firewall для использования списков:
```
# Пример правил в MikroTik
/ip firewall filter
add chain=input src-address-list=suricata_poor_reputation action=drop comment="Block poor reputation IPs"
add chain=input src-address-list=suricata_port_scan action=drop comment="Block port scanners"
add chain=input src-address-list=suricata_exploit action=drop comment="Block exploit attempts"
```

### 3. Настройка Suricata

Убедитесь, что Suricata настроена для генерации алертов в формате JSON (файл `eve.json`). Пример конфигурации в `suricata.yaml`:

```yaml
# Включение eve-log
eve-log:
  enabled: yes
  filetype: regular
  filename: eve.json
  types:
    - alert
    - http
    - dns
    - tls
```

## Установка

### 1. Установка зависимостей

```bash
# Установка librouteros
pip install librouteros

# Или из репозитория (для Debian/Ubuntu)
apt-get install python3-pip
pip3 install librouteros
```

### 2. Конфигурация

Отредактируйте следующие параметры в скрипте:

```python
# Основные настройки
MIKROTIK_IP = ""          # IP адрес MikroTik
USERNAME = ""             # Пользователь API
PASSWORD = ""             # Пароль

# Пути к файлам
EVE_FILE = "/var/log/suricata/eve.json"  # Путь к логам Suricata
```

### 3. Настройка SID для отслеживания

Скрипт настроен на отслеживание определенных SID (идентификаторов правил Suricata):

- **Плохая репутация:** SID 2403300-2403599
- **Сканирование портов:** SID 3400001-3400008
- **Эксплойты:** SID 3400020-3400021

## Запуск

### Ручной запуск:
```bash
python3 ip_blocker.py
```


## Логирование

Программа ведет логи в двух местах:

1. **Файл логов:** `/var/log/suricata/ip_blocker.log`
2. **Консольный вывод:** В реальном времени при ручном запуске

## Устранение неполадок

### 1. Проблемы с подключением к MikroTik
- Проверьте включен ли API (`/ip service print`)
- Убедитесь в правильности логина/пароля
- Проверьте доступность порта 8728

### 2. Файл логов не найден
- Убедитесь что Suricata запущена
- Проверьте путь к файлу `eve.json` в конфигурации Suricata
- Используйте функцию автоматического поиска пути

### 3. IP не добавляются в списки
- Проверьте что SID алертов соответствуют настроенным диапазонам
- Убедитесь что IP являются внешними (не из локальных диапазонов)
- Проверьте права доступа к файлу состояния

## Производительность (Регулируема)

- **Проверка каждые:** 30 секунд
- **Максимальный размер за цикл:** 10 МБ логов
- **Лимит строк за цикл:** 5000 строк
- **Задержка между добавлениями IP:** 50 мс

## Безопасность

1. Используйте отдельного пользователя API с ограниченными правами
2. Регулярно обновляйте пароли доступа
3. Мониторьте логи на предмет аномальной активности
4. Регулярно проверяйте списки блокировки на наличие ложных срабатываний

## Кастомизация

### Добавление новых SID:
```python
# В разделе конфигурации добавьте новые SID
NEW_EXPLOIT_SIDS = [3400022, 3400023]
EXPLOIT_SIDS.extend(NEW_EXPLOIT_SIDS)
```

### Изменение интервалов:
```python
CHECK_INTERVAL = 15  # Уменьшение интервала проверки
TEST_TIMEOUT = 300   # Увеличение таймаута тестовых записей
```
